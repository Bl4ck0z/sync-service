flowchart TD
    A[🚀 PASO 5: Producer-Consumer] --> B[📋 Infraestructura Lista]
    B --> C[✅ Redis + SQL Server + PostgreSQL]
    C --> D[🔄 Implementar Producer + Consumer]
    
    D --> E[📤 PRODUCER Process]
    D --> F[📥 CONSUMER Process]
    
    E --> G[🔄 Loop cada 10s]
    G --> H[📅 Redis.GET last_sync_timestamp]
    H --> I[📥 SQL Server: WHERE ULTIMA_MODIFICACION > last_sync]
    I --> J{¿Cambios nuevos?}
    
    J -->|❌ NO| K[ℹ️ Sin cambios - Sleep 10s]
    J -->|✅ SI| L[📮 Redis.LPUSH change_queue]
    L --> M[📅 Redis.SET last_sync_timestamp]
    M --> K
    K --> G
    
    F --> N[🔄 Loop continuo]
    N --> O[📦 Redis.BRPOP change_queue]
    O --> P[📊 Procesar batch de registros]
    P --> Q[🔀 UPSERT datos_vista]
    Q --> R[✅ Confirmar procesado]
    R --> N
    
    S[👥 NocoDB] -.->|READ| T[📋 datos_vista]
    S -.->|CRUD| U[✏️ datos_trabajo]
    T -.->|JOIN| U
    
    subgraph REDIS[🔥 Redis - Ya funcionando]
        V[📮 change_queue]
        W[📅 last_sync_timestamp]
        X[⚡ client_cache]
    end
    
    subgraph PG[🐘 PostgreSQL - Tablas creadas]
        T
        U
    end
    
    subgraph SQL[🏢 SQL Server - Vista disponible]
        Y[📊 VW_VENTAS_SYNC]
    end
    
    L -.->|LPUSH| V
    O -.->|BRPOP| V
    H -.->|GET| W
    M -.->|SET| W
    
    I -.->|SELECT WHERE| Y
    Q -.->|UPSERT| T
